#!/usr/bin/env node
"use strict";

var path = require("path");
var { Command } = require("commander");
var { PipelineWatcher, createPipelineRuntime } = require("@assetpipe/core/runtime");

var program = new Command();

program
  .name("assetpipe")
  .description("CLI to execute AssetPipe's pipelines")
  .version("1.0.0")
  .option("-w, --watch", "Watch mode", false)
  .option("-c, --cache <PATH>", "Cache directory")
  .option("-o, --output <PATH>", "Output directory", "out")
  .argument("<PIPELINE_PATH>");

program.parse();

var [PIPELINE_PATH] = program.args;
var options = program.opts();

async function main() {
  if (options.watch) {
    const executor = new PipelineWatcher({
      entry: PIPELINE_PATH,
      outputDirectory: options.output,
      cacheDirectory: options.cache,
    });
    
    executor.spawn();
    return;
  }

  const { runtime } = await createPipelineRuntime({
    entry: PIPELINE_PATH,
    outputDirectory: options.output,
    cacheDirectory: options.cache,
  });

  await runtime.executeAllQueries();

  const files = await runtime.computePipelineResults();

  if (files) {
    console.log("CLI", files);
  }
}

main();
// executor.execute().then(() => {
//   console.log(executor.root);
// });
